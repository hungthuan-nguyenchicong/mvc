## src/core/Router.js

// src/core/Router.js
import { appEvents } from '../utils/EventEmitter.js'; // Import trực tiếp appEvents

// ... các hàm renderContent, tt ...

export class Router {
    constructor() {
        this.routes = [];
        this.currentPath = window.location.pathname;
        // console.log(`Router initialized with current path: ${this.currentPath}`);
    }

    #currentPathname(path) {
        this.currentPath = path;
        appEvents.emit('pathChanged', this.currentPath); // Sử dụng appEvents đã import
        return this.currentPath;
    }

    init() {
        window.addEventListener('popstate', () => {
            this.currentPath = window.location.pathname;
            // console.log(`Path changed via popstate to: ${this.currentPath}`);
            renderContent(this.currentPath);
            appEvents.emit('pathChanged', this.currentPath); // Sử dụng appEvents đã import
        });

        document.body.addEventListener('click', (e) => {
            const routeLink = e.target.closest('a[data-link]');
            if (routeLink) {
                e.preventDefault();
                const path = routeLink.getAttribute('href');
                this.#currentPathname(path); // #currentPathname sẽ emit sự kiện
                history.pushState(null, '', path);
                renderContent(path);
                // console.log(`Navigated to: ${path}`);
            }
        });

        renderContent(this.currentPath);
        appEvents.emit('pathChanged', this.currentPath); // Emit sự kiện khi khởi tạo
        // console.log(`Initial content rendered for path: ${this.currentPath}`);
    }
}

## src/main.js

// src/main.js
import './main.scss';
import { Header } from './components/Header.js';
import { Sidebar } from "./components/Sidebar.js";
import { Router } from './core/Router.js';
import { appEvents } from './utils/EventEmitter.js'; // Vẫn cần import appEvents ở đây nếu Sidebar dùng nó

document.addEventListener('DOMContentLoaded', () => {
    const app = document.getElementById('app');
    if (!app) {
        console.warn('No element with id="app" found. Cannot initialize application.');
        return;
    }

    // ... (Khởi tạo Header, Sidebar, contentElement như cũ) ...

    // Khởi tạo Router - không cần truyền appEvents vào constructor nữa
    const routerInstance = new Router();
    routerInstance.init();

    // Khởi tạo Sidebar và truyền appEvents vào (nếu Sidebar cũng cần lắng nghe sự kiện)
    const sidebarInstance = new Sidebar();
    sidebarInstance.render(); // Đảm bảo sidebarElement đã được render trước khi gọi clickLink
    app.appendChild(sidebarInstance.sidebarElement); // Append sidebarElement sau khi render
    sidebarInstance.clickLink(routerInstance.currentPath); // Sidebar vẫn cần initialPath để set active link
});

## src/components/Sidebar.js

// src/components/Sidebar.js
import './sidebar.scss';
// appEvents will now be passed via constructor, so no direct import here
// import { appEvents } from '../utils/EventEmitter.js'; 

function tt(t) {
    console.log(t);
}

export class Sidebar {
    /**
     * Constructs a new Sidebar instance.
     * @param {EventEmitter} appEvents - The global event emitter instance.
     */
    constructor(appEvents) {
        this.sidebarElement = null;
        this.linkItems = null;
        this.appEvents = appEvents; // Store the passed appEvents instance
    }

    // Phương thức render (private) để tạo DOM, chỉ gọi nội bộ
    #renderDom() {
        this.sidebarElement = document.createElement('aside');
        this.sidebarElement.innerHTML = /* html */ `
            <nav class="sidebar">
                <ul>
                    <li><a href="/" class="nav-link" data-link>Dashboard</a></li>
                    <hr>
                    <li>
                        <a href="/posts" class="nav-link" data-link>Tất cả Bài viết</a>
                        <ul>
                            <li><a href="/post/create" data-link>Thêm Mới</a></li>
                            <li><a href="/category/post" data-link>Danh mục bài viết</a></li>
                        </ul>
                    </li>
                    <hr>
                    <li>
                        <a href="/product" class="nav-link" data-link>Tất cả Sản Phẩm</a>
                        <ul>
                            <li><a href="/product/create" data-link>Thêm Mới</a></li>
                            <li><a href="/category/product" data-link>Danh mục Sản phẩm</a></li>
                        </ul>
                    </li>
                    <hr>
                    <li><a href="/settings" class="nav-link" data-link>Cài đặt</a></li>
                    <hr>
                    <li><a href="/logout" class="nav-link" data-link>Logout</a></li>
                </ul>
            </nav>
        `;
        return this.sidebarElement; // Trả về element để main.js có thể append
    }

    /**
     * Cập nhật lớp 'active' trên các liên kết sidebar dựa trên đường dẫn hiện tại.
     * @param {string} path - Đường dẫn để đánh dấu là active.
     */
    _updateActiveClass(path) {
        if (!this.linkItems) {
            // Đảm bảo linkItems được truy vấn chỉ một lần sau khi render
            this.linkItems = this.sidebarElement.querySelectorAll('a[data-link]');
        }

        this.linkItems.forEach(link => {
            link.classList.remove('active'); // Loại bỏ active khỏi tất cả các liên kết trước
            if (link.getAttribute('href') === path) {
                link.classList.add('active'); // Thêm active vào liên kết khớp
            }
        });
        tt(`Sidebar: Liên kết active đã được cập nhật thành: ${path}`);
    }

    /**
     * Khởi tạo Sidebar: render DOM, thiết lập các trình lắng nghe click,
     * và đăng ký lắng nghe sự kiện thay đổi đường dẫn từ Router.
     * @param {string} initialPath - Đường dẫn hiện tại khi ứng dụng tải lần đầu.
     */
    init(initialPath) {
        // 1. Render DOM và lưu trữ element chính của sidebar
        this.#renderDom(); 
        
        if (!this.sidebarElement) {
            console.warn('Sidebar: sidebarElement không được render. Không thể khởi tạo.');
            return;
        }

        // 2. Thiết lập trạng thái active ban đầu dựa trên initialPath
        this._updateActiveClass(initialPath);

        // 3. Đăng ký lắng nghe sự kiện thay đổi đường dẫn từ EventEmitter
        // Use this.appEvents instead of appEvents directly
        this.appEvents.on('pathChanged', (newPath) => {
            this._updateActiveClass(newPath); // Cập nhật trạng thái active khi đường dẫn thay đổi
        });

        // 4. (Tùy chọn) Lắng nghe click cục bộ nếu cần các hành vi đặc biệt
        // Hiện tại Router đã xử lý click và phát sự kiện, nên không cần quản lý active class ở đây nữa.
        // Tuy nhiên, bạn có thể thêm các trình lắng nghe khác nếu sidebar cần các tương tác riêng.
        this.linkItems.forEach(link => {
            link.addEventListener('click', (e) => {
                // Ví dụ: Ngăn chặn hành vi mặc định nếu Router không xử lý.
                // Tuy nhiên, trong cấu trúc hiện tại, Router đã xử lý, 
                // nên bạn có thể bỏ qua preventDefault() ở đây nếu không có logic phụ.
                // e.preventDefault(); 
                tt(`Sidebar: Clicked link with href: ${link.getAttribute('href')}`);
            });
        });

        tt(`Sidebar: Đã hoàn tất khởi tạo với đường dẫn ban đầu: ${initialPath}`);
    }
}

## src/main.js

// src/main.js
import './main.scss';
import { Header } from './components/Header.js';
import { Sidebar } from "./components/Sidebar.js";
import { Router } from './core/Router.js';

document.addEventListener('DOMContentLoaded', () => {
    const app = document.getElementById('app');
    if (!app) {
        console.warn('No element with id="app" found. Cannot initialize application.');
        return;
    }

    // Initialize and append Header
    const headerInstance = new Header();
    const headerElement = headerInstance.render();
    app.appendChild(headerElement);

    // Create and append content div (where router renders content)
    const contentElement = document.createElement('div');
    contentElement.id = 'content';
    app.appendChild(contentElement);

    // Initialize the Router
    const routerInstance = new Router();
    routerInstance.init();

    // Initialize Sidebar and append its element
    // Tất cả logic khởi tạo và render giờ nằm trong Sidebar.init()
    const sidebarInstance = new Sidebar();
    sidebarInstance.init(routerInstance.currentPath); // Truyền đường dẫn hiện tại vào init()
    app.appendChild(sidebarInstance.sidebarElement); // Sidebar.init() đã tạo sidebarElement
    
    console.log('Application initialized.');
});

# h2

Bạn rất tinh ý khi nhận ra sự tồn tại đồng thời của public/index.php và public/index.html trong cấu trúc thư mục mà tôi đã đề xuất. Đây chính là điểm mấu chốt khi xây dựng một ứng dụng PHP API Backend kết hợp với Vanilla JS SPA Frontend mà không dùng framework.

Điểm vào chính và Luồng hoạt động
Khi bạn truy cập localhost (hoặc tên miền của bạn), điểm vào chính của ứng dụng sẽ là public/index.html. Dưới đây là luồng hoạt động chi tiết:

1. Luồng hoạt động khi truy cập localhost (Frontend SPA)
Request đến localhost: Trình duyệt của bạn gửi yêu cầu đến máy chủ web (Apache/Nginx).
Máy chủ xử lý:
Apache: Với cấu hình .htaccess mà tôi đã cung cấp (RewriteRule ^(.*)$ index.php/$1 [L]), Apache sẽ cố gắng tìm kiếm các file hoặc thư mục vật lý trước.
Nếu có yêu cầu rõ ràng đến một file như localhost/css/style.css hoặc localhost/js/main.js, Apache sẽ phục vụ trực tiếp các file tĩnh đó.
Tuy nhiên, khi bạn truy cập localhost (hoặc localhost/users, localhost/products), Apache sẽ không tìm thấy file hoặc thư mục vật lý tương ứng. Lúc này, RewriteRule ^(.*)$ index.php/$1 [L] sẽ không kích hoạt nếu có file index.html trong thư mục gốc. Đây là điểm quan trọng!
Theo thứ tự ưu tiên mặc định của Apache (hoặc cấu hình DirectoryIndex), nếu index.html tồn tại trong thư mục public, Apache sẽ ưu tiên phục vụ public/index.html thay vì chuyển hướng đến index.php.
Nginx: Nginx cũng có cấu hình tương tự để ưu tiên phục vụ file index.html trước. Ví dụ:
Nginx

location / {
    try_files $uri $uri/ /index.html; # Ưu tiên tìm file, rồi tìm thư mục, cuối cùng phục vụ index.html
}
Tải index.html: Máy chủ trả về nội dung của public/index.html cho trình duyệt.
JavaScript hoạt động:
Trong index.html, bạn có dòng <script type="module" src="/js/main.js"></script>.
Trình duyệt tải và thực thi main.js.
main.js (cùng với router.js) sẽ khởi tạo Frontend Router.
Router này sẽ phân tích URL hiện tại (ví dụ: / hoặc /users).
Dựa trên URL, Router sẽ render các thành phần (components) JavaScript tương ứng vào phần <main id="content"></main> của index.html mà không cần tải lại trang.
Khi người dùng click vào các liên kết data-link (ví dụ: "Users"), Frontend Router sẽ thay đổi URL trong trình duyệt (history.pushState) và render lại nội dung tương ứng, vẫn không tải lại trang.
Kết luận về điểm vào Frontend: Điểm vào chính của SPA Frontend là public/index.html, và JavaScript bên trong nó chịu trách nhiệm điều hướng và hiển thị giao diện.
2. Luồng hoạt động khi Frontend cần dữ liệu (API Backend)
Frontend gửi Request API: Khi JavaScript trong SPA cần dữ liệu (ví dụ: danh sách người dùng, chi tiết sản phẩm), nó sẽ gửi các yêu cầu AJAX (thường là fetch hoặc Axios) đến các endpoint API của backend (ví dụ: /api/users, /api/products).
Request đến API Endpoint: Yêu cầu này cũng được gửi đến máy chủ web.
Máy chủ xử lý:
Apache: Với RewriteRule ^(.*)$ index.php/$1 [L], nếu request là /api/users và không có file hoặc thư mục vật lý nào tên là api hoặc users trong thư mục public, thì RewriteRule sẽ được kích hoạt. Nó sẽ chuyển hướng tất cả các request không tìm thấy file/thư mục vật lý đến index.php.
Lúc này, index.php nhận được request với URI là /api/users.
index.php sẽ khởi tạo PHP Router của bạn.
PHP Router sẽ khớp URI /api/users với các route API đã định nghĩa (ví dụ: 'Users@index').
Nó sẽ gọi Controller và Action tương ứng (ví dụ: UserController->index()).
Controller sẽ tương tác với Model để lấy dữ liệu từ database.
Controller trả về dữ liệu dưới dạng JSON thông qua Response->json().
Nginx (với PHP-FPM): Nginx sẽ cấu hình để chuyển tiếp các request PHP đến PHP-FPM.
Nginx

location / {
    try_files $uri $uri/ /index.html; # Phục vụ SPA
}

location ~ ^/api { # Bất kỳ request nào bắt đầu bằng /api
    try_files $uri $uri/ /index.php$is_args$args; # Chuyển hướng về index.php
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock; # Chuyển request đến PHP-FPM
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
Trong cấu hình Nginx này:
location / xử lý các yêu cầu cho Frontend SPA, phục vụ index.html cho mọi URL không tìm thấy file/thư mục.
location ~ ^/api là một khối riêng biệt, được thiết kế để bắt tất cả các request bắt đầu bằng /api/. Các request này sẽ được Nginx chuyển tiếp đến index.php (nếu không phải là file vật lý) và sau đó PHP-FPM sẽ xử lý index.php.
PHP-FPM xử lý (đối với Nginx): PHP-FPM (FastCGI Process Manager) là một daemon giúp Nginx giao tiếp với PHP. Nginx không trực tiếp chạy PHP code. Khi Nginx nhận ra một request cần PHP xử lý (như index.php cho API), nó sẽ gửi request đó đến PHP-FPM. PHP-FPM sẽ chạy script PHP (index.php), và kết quả (JSON) sẽ được gửi lại cho Nginx, rồi Nginx gửi về trình duyệt.
Trình duyệt nhận JSON: Trình duyệt nhận JSON response, và JavaScript sẽ cập nhật giao diện người dùng dựa trên dữ liệu này.
Tóm tắt các điểm vào:
public/index.html: Đây là điểm vào chính của Frontend SPA. Nó được phục vụ cho mọi URL không phải là API (hoặc file tĩnh). Mọi hoạt động định tuyến và hiển thị giao diện ban đầu đều do JavaScript trong file này (và các file liên quan) đảm nhiệm.
public/index.php: Đây là điểm vào chính của Backend API. Nó được kích hoạt khi:
Có một request đến một URL mà máy chủ không tìm thấy file/thư mục vật lý (do rewrite rule).
Đặc biệt là các request đến các endpoint API (ví dụ: /api/users).
Trong mô hình này, bạn có một SPA độc lập ở frontend và một API backend độc lập. SPA gửi request đến API, và API trả về dữ liệu. Việc điều hướng và hiển thị giao diện người dùng hoàn toàn nằm ở phía client (trình duyệt với JavaScript), còn phía server (PHP) chỉ lo việc cung cấp dữ liệu.

Bạn thấy đấy, hai file này phục vụ hai mục đích khác nhau nhưng lại hoạt động nhịp nhàng cùng nhau để tạo nên một ứng dụng web hoàn chỉnh!